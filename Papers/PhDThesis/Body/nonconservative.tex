\chapter{Nonconservative Discontinuous Galerkin Methods}

  \section{Definition}
    Consider the nonconservative product
    \[
      g(\v{q}) \d{\v{q}}{x},
    \]
    where \(g(\v{q}): \RR^p \to \RR^p \times \RR^p\) is continuous, but \(\v{q}\) is
    possibly discontinuous.
    In this case, the product is traditionally not well-defined at the discontinuities
    of \(\v{q}\).
    In order to define this product for discontinuous functions, \(\v{q}\), it is
    possible to regularize \(\v{q}\) with a path \(\phi \) at discontinuities according
    to the theory laid out by Dal Maso, Le Floch, and Murat.
    To this end consider Lipschitz continuous paths,
    \(\v{\psi}:\br{0, 1} \times \RR^p \times \RR^p \to \RR^p \), that satisfy the
    following properties.
    \begin{enumerate}
      \item \(\forall \v{q}_L, \v{q}_R \in \RR^p\),
        \(\v{\psi}(0, \v{q}_L, \v{q}_R) = \v{q}_L\) and
        \(\v{\psi}(1, \v{q}_L, \v{q}_R) = \v{q}_R\)
      \item \(\exists k > 0\), \(\forall \v{q}_L, \v{q}_R \in \RR^p\),
        \(\forall s \in \br{0, 1}\), \(\abs{\pd{\v{\psi}}{s}(s, \v{q}_L, \v{q}_R)}
        \le k \abs{\v{q}_L - \v{q}_R}\) elementwise
      \item \(\exists k > 0\), \(\forall \v{q}_L, \v{q}_R, \v{u}_L, \v{u}_R \in \RR^p\),
        \(\forall s \in \br{0, 1}\), elementwise
        \[
          \abs{\pd{\v{\psi}}{s}(s, \v{q}_L, \v{q}_R)
          - \pd{\v{\psi}}{s}(s, \v{u}_L, \v{u}_R)}
          \le k \p{\abs{\v{q}_L - \v{u}_L} + \abs{\v{q}_R - \v{u}_R}}
        \]
    \end{enumerate}
    Once we have these paths, \(\v{\psi} \), we can define the nonconservative product.

    Let \(\v{q}:\br{a, b} \to \RR^p\) be a function of bounded variation, let
    \(g: \RR^p \to \RR^p \times \RR^p \) be a continuous function, and let \(\v{\psi} \)
    satisfy the properties given above.
    Then there exists a unique real-valued bounded Borel measure \(\v{\mu}\) on
    \(\br{a, b}\) characterized by the two following properties.
    \begin{enumerate}
      \item If \(q\) is continuous on a Borel set \(B \subset \br{a, b}\), then
        \[
          \v{\mu}(B) = \dintt{B}{}{g(\v{q}) \d{\v{q}}{x}}{x}
        \]
      \item If \(q\) is discontinuous at a point \(x_0 \in \br{a, b}\), then
        \[
          \v{\mu}({x_0}) = \dintt{0}{1}{g(\v{\psi}(s; \v{q}(x_0^-), \v{q}(x_0^+)))
          \pd{\v{\psi}}{s}(s; \v{q}(x_0^-), \v{q}(x_0^+))}{s}
        \]
    \end{enumerate}
    By definition, this measure \(\v{\mu}\) is the nonconservative product
    \(g(\v{q}) \d{\v{q}}{x}\) and will be denoted by
    \[
      \v{\mu} = \br[\v{\psi}]{g(\v{q}) \d{\v{q}}{x}}
    \]

    Note that if there exists a function \(\v{f}\p{\v{q}}\) such that
    \(\v{f}'\p{\v{q}} = g(\v{q})\), then
    \begin{gather}
      \dintt{0}{1}{g(\v{\psi}(s; \v{q}(x_0^-), \v{q}(x_0^+)))
      \pd{\v{\psi}}{s}(s; \v{q}(x_0^-), \v{q}(x_0^+))}{s}
      = \v{f}\p{\v{q}(x_0^+)} - \v{f}\p{\v{q}(x_0^-)}
    \end{gather}
    for any path \(\v{\psi}\) that satisfies the conditions 1 --- 3.

  \subsection{Higher Dimensions}

    \noindent In higher dimensions the paths, \(\v{\psi}\) must also have the property
    that
    \begin{enumerate}
      \item[4.] \(\v{\psi}(s, \v{q}_L, \v{q}_R) = \v{\psi}(1 - s, \v{q}_L, \v{q}_R)\)
    \end{enumerate}
    Then the following Theorem can be given in spacetime
    Let \(\v{q}: \Omega \to \RR^m\) be a bounded function of bounded variation defined
    on an open subset \(\Omega \) of \(\RR^{n+1}\) and \(\v{t}: \RR^m \to \RR^m\) be
    a locally bounded Borel function.
    Then there exists a unique family of real-valued bounded Borel measures \(\mu_i\)
    on \(\Omega \), \(i = 1, 2, \ldots, m\) such that
    \begin{enumerate}
      \item if \(B\) is a continuous Borel subset of \(\Omega \), then
        \[
          \mu_i(B) = \dintt{B}{}{t_{ik}(q) \v{q}_{x_k}}{\lambda}
        \]
        where \(\lambda \) is the Borel measure;

      \item if \(B\) is a discontinuous subset of \(\Omega \) of approximate jump, then
        \[
          \mu_i(B) = \dintt{B}{}{\dintt{0}{1}{t_{ik}(\v{\psi}(s, \v{q}^L, \v{q}^R))
            \pd{\v{\psi}}{s}(s, \v{q}^L, \v{q}^R)}{s} \v{n}_k^L}{H^n}
        \]
        with \(\v{q}^L\) and \(\v{q}^R\) the left and right traces at the discontinuity,
        where \(H^n\) is the n-dimensional Hausdorf measure and where we choose
        \(\v{n}^L\) the outward normal with respect to the left state,

      \item if \(B\) is an irregular Borel subset of \(\Omega \), then \(\mu_i(B) = 0\)
    \end{enumerate}
    % \noindent This is given in Rhebergen without proof, but I haven't found any outside
    % original references for this Theorem.
    % Mostly this reflects the one dimensional theorem, but I don't understand the
    % appearance of the outward facing normal.
    % It appears to have been an arbitrary choice between \(\v{n}^L\) and \(\v{n}^R\).
    % Also I am not sure why it is necessary at all.

  \section{Weak Solutions}
    A function \(\v{q}\) of bounded variation is a weak solution to
    \begin{gather}
      \v{q}_t + g(\v{q}) \v{q}_x = 0
    \end{gather}
    if
    \begin{gather}
      \v{q}_t + \br[\phi]{g(\v{q}) \v{q}_x} = 0
    \end{gather}
    as a bounded Borel measure on \(\RR \times \RR_+\).
    This is equivalent to finding \(\v{q}\) that satisfies,
    \begin{gather}
      \dintt{\RR_+}{}{\dintt{\RR}{}{v_t(t, x) \v{q}(t, x)}{x}}{t}
      + \dintt{\RR_+}{}{\dint{\RR}{}{v(t, \cdot) \br[\psi]{g(\v{q}(t, \cdot))
        \v{q}_x(t, \cdot)}}}{t}
      = \v{0}
    \end{gather}
    for all functions \(v \in C^{\infty}_0\p{\RR_t \times \RR}\).

  \section{DG Weak Formulation}

  \subsection{Rhebergen Weak Formulation}
    Find \(\v{q} \in V_h\) such that for all \(\v{v} \in V_h\),
    \begin{gather}
      \sum{j}{}{\dintt{K_j}{}{\v{v}^T \v{q}_t - \v{v}^T_x \v{f}(\v{q})
        + \v{v}^T g(\v{q}) \v{q}_x}{x}}
      + \sum{S}{}{\dintt{S}{}{\p{\v{v}^L - \v{v}^R}^T \hat{\v{P}}^{nc}}{S}} \\
      + \sum{S}{}{\dintt{S}{}{\frac{1}{2}\p{\v{v}^R + \v{v}^L}^T
        \dintt{0}{1}{g\p{\v{\psi}\p{\tau, \v{q}^L, \v{q}^R}}
        \pd{\v{\psi}}{\tau}(\tau, \v{q}^L, \v{q}^R)}{\tau}}{S}}
    \end{gather}
    where \(\hat{\v{P}}^{nc}\) is the nonconservative numerical flux, if symmetrical
    wave speeds are assumed, then the Rusanov or Local Lax Friedrichs flux can be used,
    otherwise the nonconservative product will affect the numerical flux.

  \subsection{Standard Hyperbolic Conservation Law DG Formulation}
    Let \(\set{K_j}\) be a mesh of the domain \(\br{a, b}\).
    Also denote the DG space as
    \[
      V_h = \set{v \in L^1\p{\br{a, b}} \big| \eval{v}{K_j} \in \PP^M(K_j)}
    \]
    Consider the hyperbolic conservation law given below with the corresponding
    classical and semi discrete weak solutions.
    \begin{gather}
      \v{q}_t + \v{f}\p{\v{q}}_x = 0 \\
      \dintt{a}{b}{v \v{q}_t - v_x \v{f}\p{\v{q}}}{x} = 0
    \end{gather}
    The DG formulation requires finding \(\v{q}_h \in V_h\) for all \(v_h \in V_h\) such
    that
    \begin{gather}
      \dintt{a}{b}{v_h \v{q}_{h,t} + v_h \v{f}\p{\v{q}_h}_x}{x} = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t} + v_h \v{f}\p{\v{q}_h}_x}{x}} = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{\dintt{K_j}{}{v_h \v{f}\p{\v{q}_h}_x}{x}} = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{\eval*{\hat{v}_h \hat{f}\p{\v{q}_h}}{x_{j-1/2}}{x_{j+1/2}}
        - \dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}_h}}{x}} = 0
    \end{gather}
    Usually the value of \(\hat{v}_h\) is the interior value of the test function on
    the element integral that is being integrated by parts.
    That is
    \begin{gather}
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{v_h\p{x_{j+1/2}^-} \hat{f}_{j+1/2}
        - v_h\p{x_{j-1/2}^+} \hat{f}_{j-1/2}
        - \dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}_h}}{x}} = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{I_j}{}{\p{v_h\p{x^-} - v_h\p{x^+}} \hat{f}}
        - \sum{j}{}{\dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}_h}}{x}} = 0
    \end{gather}
    Using these values for the test functions at the interfaces and then grouping the
    interfaces together reveals jump terms in the test functions at the interfaces.

    % I see that if the value of the test functions had a single value at the interfaces
    % like the numerical fluxes, \(\hat{f}\), then when combining the values at each
    % interface the terms would cancel out.
    % Does choosing the interior value for the test functions just make sure that those
    % interface terms don't cancel out, or what is the theoretical reason for the values
    % of the test functions at the interfaces.

  \subsection{Pure Nonconservative DG Formulation}
    Consider the 1D nonconservative equation shown below,
    \[
      \v{q}_t + g(\v{q}) \v{q}_x = \v{0} \qquad x \in \br{a, b}, 0 < t < T
    \]
    Now the semi discrete DG formulation for this problem becomes finding
    \(\v{q}_h \in V_h\) for all \(v_h \in V_h\) that satisfies
    \begin{gather}
      \dintt{a}{b}{v_h \v{q}_{h,t}}{x}
      + \dintt{a}{b}{v_h \br[\psi]{g(\v{q}_h)\v{q}_{h,x}}}{x} = \v{0} \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{\dintt{K_j}{}{v_h g(\v{q}_h) \v{q}_{h,x}}{x}}
      + \sum{I}{}{\hat{v}_h \dintt{0}{1}{g(\psi(s, \v{q}_h^L, \v{q}_h^R))
        \pd{\psi}{s}(s, \v{q}_h^L, \v{q}_h^R)}{s}}
      = 0
    \end{gather}

    Consider the case where there exists a function \(\v{f}\p{\v{q}_h}\) such that
    \(\v{f}'\p{\v{q}_h} = g(\v{q})\).
    \begin{gather}
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{\dintt{K_j}{}{v_h \v{f}\p{\v{q}_h}_x}{x}}
      + \sum{I}{}{\hat{v}_h \dintt{0}{1}{f'(\psi(s, \v{q}_h^L, \v{q}_h^R))
        \pd{\psi}{s}(s, \v{q}_h^L, \v{q}_h^R)}{s}}
      = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      + \sum{j}{}{\dintt{K_j}{}{v_h \v{f}\p{\v{q}_h}_x}{x}}
      + \sum{I}{}{\hat{v}_h \p{\v{f}\p{\v{q}_h^R} - \v{f}\p{\v{q}_h^L}}}
      = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      - \sum{j}{}{\dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}_h}}{x}}
      + \sum{I}{}{v_h^L \v{f}\p{\v{q}_h^L} - v_h^R \v{f}\p{\v{q}_h^R}}
      + \sum{I}{}{\hat{v}_h \p{\v{f}\p{\v{q}_h^R} - \v{f}\p{\v{q}_h^L}}}
      = 0 \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_{h,t}}{x}}
      - \sum{j}{}{\dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}_h}}{x}}
      + \sum{I}{}{\p{\hat{v} - v_h^R} \v{f}\p{\v{q}_h^R}
      + \p{v_h^L - \hat{v}} \v{f}\p{\v{q}_h^L}}
      = 0
    \end{gather}
    Now we want to choose \(\hat{v}\) such that this is equivalent to the traditional
    DG formulation.
    However we don't have any numerical flux terms so instead we want the interface
    terms to look like
    \(\p{v_h^L - v_h^R} \frac{1}{2} \p{\v{f}\p{\v{q}_h^R} + \v{f}\p{\v{q}_h^L}}\).
    At least this is what Rhebergen does and then replaces the flux average with the
    numerical flux.
    \begin{gather}
      \p{\hat{v} - v_h^R} \v{f}\p{\v{q}_h^R} + \p{v_h^L - \hat{v}} \v{f}\p{\v{q}_h^L}
      = \p{v_h^L - v_h^R} \frac{1}{2} \p{\v{f}\p{\v{q}_h^R} + \v{f}\p{\v{q}_h^L}} \\
      \p{\hat{v} - v_h^R} \v{f}\p{\v{q}_h^R} + \p{v_h^L - \hat{v}} \v{f}\p{\v{q}_h^L}
      = \frac{1}{2} \p{v_h^L - v_h^R} \v{f}\p{\v{q}_h^R}
      + \frac{1}{2} \p{v_h^L - v_h^R} \v{f}\p{\v{q}_h^L} \\
      \p{\hat{v} - v_h^R} = \frac{1}{2} \p{v_h^L - v_h^R} \\
      \hat{v} = \frac{1}{2} \p{v_h^L + v_h^R} \\
      \p{v_h^L - \hat{v}} = \frac{1}{2} \p{v_h^L - v_h^R} \\
      -\hat{v} = \frac{1}{2} \p{- v_h^L - v_h^R} \\
      \hat{v} = \frac{1}{2} \p{v_h^L + v_h^R} \\
    \end{gather}
    We see that the appropriate numerical flux for the test function when multiplying
    the nonconservative product at the interface should be the average value.
    This agrees with the results given in Rhebergen.
    My one question about this is the swap from the average value of \(f\) to the
    numerical flux of \(f\).
    I am tempted to use the numerical flux of \(f\) when integrating by parts, but then
    in order to agree with the traditional method \(\hat{v}\) should be zero.

  \subsection{DG Formulation}
    Consider the 1D PDE below with a conservative and nonconservative term,
    \begin{gather}
      \v{q}_t + \v{f}\p{\v{q}}_x + g\p{\v{q}} \v{q}_x = \v{s}\p{\v{q}}
      \qquad x \in \br{a, b}, 0 < t < T \\
    \end{gather}
    The semi discrete DG formulation is finding \(\v{q}_h \in V_h\) for all
    \(v_h \in V_h\) such that
    \begin{gather}
      \dintt{a}{b}{v_h \v{q}_t}{x} + \dintt{a}{b}{v_h \v{f}\p{\v{q}}_x}{x} +
        \dint{a}{b}{v_h \br[\v{\psi}]{g\p{\v{q}} \v{q}_x}}
        = \dintt{a}{b}{v_h\v{s}\p{\v{q}}}{x} \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_t}{x}}
        + \sum{j}{}{\dintt{K_j}{}{v_{h} \v{f}\p{\v{q}}}{x}}
        + \sum{j}{}{\dintt{K_j}{}{v_h g\p{\v{q}} \v{q}_x}{x}} \\
        + \sum{I}{}{\hat{v}_h \dintt{0}{1}{g\p{\v{\psi}\p{s, \v{q}^L_h, \v{q}^R_h}}
          \pd{\v{\psi}}{s}\p{s, \v{q}^L_h, \v{q}^R_h}}{s}}
        = \dintt{a}{b}{v_h\v{s}\p{\v{q}}}{x} \\
      \sum{j}{}{\dintt{K_j}{}{v_h \v{q}_t}{x}}
        - \sum{j}{}{\dintt{K_j}{}{v_{h,x} \v{f}\p{\v{q}}}{x}}
        + \sum{I}{}{\p{v_h^L - v_h^R} \hat{\v{f}}}
        + \sum{j}{}{\dintt{K_j}{}{v_h g\p{\v{q}} \v{q}_x}{x}} \\
        + \sum{I}{}{\hat{v}_h \dintt{0}{1}{g\p{\v{\psi}\p{s, \v{q}^L_h, \v{q}^R_h}}
          \v{\psi}_s\p{s, \v{q}^L_h, \v{q}^R_h}}{s}}
        = \dintt{a}{b}{v_h\v{s}\p{\v{q}}}{x}
    \end{gather}
    As shown earlier if we choose \(\hat{v}_h = \frac{1}{2}\p{v_h^R + v_h^L}\), then
    in the case where there exists \(\v{h}\) such that \(\v{h}' = g\), then this
    formulation will reduce to the standard DG formulation of the conservative PDE
    \(\v{q}_t + \p{\v{f}\p{\v{q}} + \v{h}\p{\v{q}}}_x = \v{s}\p{\v{q}}\).

    Consider the case where \(v_h = \phi_i^k\), that is the kth order basis function on
    the element \(K_i\).
    In order to consider all of the basis functions on a cell \(K_i\), I will use the
    test function \(\v{\phi}_i^T\).
    Let \(\v{\phi}\) be the vector of basis functions on the canonical element
    \(\br{-1,1}\) and let \(c_i\) be the linear transformation from
    \(K_i \to \br{-1, 1}\), then \(\v{\phi}_i(x) = \v{\phi}(c_i(x))\)
    \begin{gather}
      \dintt{a}{b}{\v{q}_t \v{\phi}_i^T}{x}
        + \dintt{a}{b}{\v{f}\p{\v{q}}_x \v{\phi}_i^T}{x}
        + \dint{a}{b}{\br[\v{\psi}]{g\p{\v{q}} \v{q}_x} \v{\phi}_i^T}
        = \dintt{a}{b}{\v{s}\p{\v{q}} \v{\phi}_i^T}{x} \\
      \dintt{K_i}{}{\v{q}_t \v{\phi}_i^T}{x}
        + \dintt{K_i}{}{\v{f}\p{\v{q}}_x \v{\phi}_i^T}{x}
        + \dintt{K_i}{}{g\p{\v{q}} \v{q}_x \v{\phi}_i^T}{x}
        + \dintt{0}{1}{g(\v{\psi}(s, \v{q}_{i-1/2}^-, \v{q}_{i-1/2}^+))
          \v{\psi}_s(s, \v{q}_{i-1/2}^-, \v{q}_{i-1/2}^+)}{s} \,
          \hat{\v{\phi}}^T_{i-1/2} \\
        + \dintt{0}{1}{g(\v{\psi}(s, \v{q}_{i+1/2}^-, \v{q}_{i+1/2}^+))
          \v{\psi}_s(s, \v{q}_{i+1/2}^-, \v{q}_{i+1/2}^+)}{s} \,
          \hat{\v{\phi}}^T_{i+1/2}
        = \dintt{K_i}{}{\v{s}\p{\v{q}} \v{\phi}_i^T}{x}
      \intertext{The value of \(\v{q}\) restricted to cell \(K_i\) can be expressed as
        an expansion of coefficients over the basis functions, that is
        \(\eval{\v{q}(x, t)}{K_i} = Q_i(t) \v{\phi}_i(x)\)}
      \dintt{K_i}{}{Q_i' \v{\phi}_i \v{\phi}_i^T}{x}
        + \dintt{K_i}{}{\v{f}\p{Q_i \v{\phi}_i}_x \v{\phi}_i^T}{x}
        + \dintt{K_i}{}{g\p{Q_i \v{\phi}_i} Q_i \v{\phi}_{i,x} \v{\phi}_i^T}{x} \\
        + \dintt{0}{1}{g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_{i}\v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i-1/2} \\
        + \dintt{0}{1}{g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1} \v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i+1/2}
        = \dintt{K_i}{}{\v{s}\p{Q_i \v{\phi}_1} \v{\phi}_i^T}{x}
      \intertext{Integrate by Parts}
      \dintt{K_i}{}{Q_i' \v{\phi}_i \v{\phi}_i^T}{x}
        + \hat{\v{f}}_{i+1/2}\v{\phi}^T(1) - \hat{\v{f}}_{i-1/2}\v{\phi}^T(-1)
        + \dintt{K_i}{}{g\p{Q_i \v{\phi}_i} Q_i \v{\phi}_{i,x} \v{\phi}_i^T}{x} \\
        + \dintt{0}{1}{g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_i \v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i-1/2} \\
        + \dintt{0}{1}{g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i+1/2}
        = \dintt{K_i}{}{\v{s}\p{Q_i \v{\phi}_1} \v{\phi}_i^T}{x}
      \intertext{Change to canonical basis with linear transformation, and rearrange
        equation}
      \dintt{K_i}{}{Q_i' \v{\phi}(c_i(x)) \v{\phi}^T(c_i(x))}{x}
        = \dintt{K_i}{}{\v{f}\p{Q_i \v{\phi}(c_i(x))} \partial_x \v{\phi}^T(c_i(x))}{x}
        - \p{\hat{\v{f}}_{i+1/2}\v{\phi}^T(1) - \hat{\v{f}}_{i-1/2}\v{\phi}^T(-1)} \\
        - \dintt{K_i}{}{g\p{Q_i \v{\phi}(c_i(x))} Q_i \partial_x \v{\phi}(c_i(x))
          \v{\phi}^T(c_i(x))}{x}
        - \dintt{0}{1}{g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_i \v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i-1/2} \\
        - \dintt{0}{1}{g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i+1/2}
        + \dintt{K_i}{}{\v{s}\p{Q_i \v{\phi}(c_i(x))} \v{\phi}^T(c_i(x))}{x}
      \intertext{Convert integrals to canonical element, denote
        \(c_i^{-1}(\xi) = b_i(\xi)\) and \(m_i = \pd{b_i}{\xi}\).
        Performing two operations,
        \(\partial_x \v{\phi}(c_i(x)) = \v{\phi}_{\xi}(c_i(x)) c_i'(x) =
        \frac{1}{m_i} \v{\phi}(c_i(x))\)
        and transforming integrals from \(K_i\) to \(\br{-1, 1}\) results in
        \(x = b_i(\xi)\) or \(c_i(x) = \xi \) and multiply by measure \(m_i\).
        Drop explicit dependence on \(\xi \), \(\phi = \phi(\xi)\)}
      \dintt{-1}{1}{Q_i' \v{\phi} \v{\phi}^T m_i}{\xi}
        = \dintt{-1}{1}{\v{f}\p{Q_i \v{\phi}} \frac{1}{m_i} \v{\phi}_{\xi}^T m_i}{\xi}
        - \p{\hat{\v{f}}_{i+1/2}\v{\phi}^T(1) - \hat{\v{f}}_{i-1/2}\v{\phi}^T(-1)} \\
        - \dintt{-1}{1}{g\p{Q_i \v{\phi}} Q_i \frac{1}{m_i} \v{\phi}_{\xi}
          \v{\phi}^T m_i}{\xi}
        - \dintt{0}{1}{g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_i \v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i-1/2} \\
        - \dintt{0}{1}{g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1))}{s} \,
          \hat{\v{\phi}}^T_{i+1/2}
        + \dintt{-1}{1}{\v{s}\p{Q_i \v{\phi}} \v{\phi}^T m_i}{\xi}
      \intertext{Simplify, note that as before \(\hat{\v{\phi}}\) is the interface
        average, so in this case it results in half the interior value.}
      m_i Q_i' \dintt{-1}{1}{\v{\phi} \v{\phi}^T}{\xi}
        = \dintt{-1}{1}{\v{f}\p{Q_i \v{\phi}} \v{\phi}_{\xi}^T}{\xi}
        - \p{\hat{\v{f}}_{i+1/2}\v{\phi}^T(1) - \hat{\v{f}}_{i-1/2}\v{\phi}^T(-1)} \\
        - \dintt{-1}{1}{g\p{Q_i \v{\phi}} Q_i \v{\phi}_{\xi} \v{\phi}^T}{\xi}
        - \frac{1}{2}\dintt{0}{1}{g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_i \v{\phi}(-1))}{s} \,
          \v{\phi}^T(-1) \\
        - \frac{1}{2}\dintt{0}{1}{g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1} \v{\phi}(-1))}{s} \,
          \v{\phi}^T(1)
        + m_i \dintt{-1}{1}{\v{s}\p{Q_i \v{\phi}} \v{\phi}^T}{\xi}
      \intertext{The integral on the left hand side gives the mass matrix, right
        multiplying by \(M^{-1}\) and dividing \(m_i\) across gives}
      Q_i' = \frac{1}{m_i} \dintt{-1}{1}{\v{f}\p{Q_i \v{\phi}}
        \v{\phi}_{\xi}^T}{\xi} \, M^{-1}
        - \frac{1}{m_i} \p{\hat{\v{f}}_{i+1/2}\v{\phi}^T(1)
          - \hat{\v{f}}_{i-1/2}\v{\phi}^T(-1)} M^{-1} \\
        - \frac{1}{m_i}\dintt{-1}{1}{g\p{Q_i \v{\phi}}
          Q_i \v{\phi}_{\xi} \v{\phi}^T}{\xi} M^{-1} \\
        - \frac{1}{2m_i}\dintt{0}{1}{
          g(\v{\psi}(s, Q_{i-1} \v{\phi}(1), Q_i \v{\phi}(-1)))
          \v{\psi}_s(s, Q_{i-1}\v{\phi}(1), Q_i \v{\phi}(-1))}{s} \,
          \v{\phi}^T(-1) M^{-1} \\
        - \frac{1}{2m_i}\dintt{0}{1}{
          g(\v{\psi}(s, Q_i \v{\phi}(1), Q_{i+1}\v{\phi}(-1)))
          \v{\psi}_s(s, Q_i \v{\phi}(1), Q_{i+1} \v{\phi}(-1))}{s} \,
          \v{\phi}^T(1) M^{-1}
        + \dintt{-1}{1}{\v{s}\p{Q_i \v{\phi}} \v{\phi}^T}{\xi} \, M^{-1}
    \end{gather}

  \subsection{Two Dimensions}
    Consider the two dimensional balance law given by
    \begin{equation}
      \v{q}_t + \div \v{f}_j\p{\v{q}, \v{x}, t} + \M{G}_j\p{\v{q}, \v{x}, t} \v{q}_{x_j}
       = \v{s}\p{\v{q}, \v{x}, t}
    \end{equation}
    Note that the flux function is a matrix or two index tensor, so the divergence is a
    vector quantity, and the nonconservative term is a sum over the dimensions.
    It could also be written as
    \begin{equation}
      \v{q}_t + \v{f}_1\p{\v{q}, \v{x}, t}_x + \v{f}_2\p{\v{q}, \v{x}, t}_y
      + \M{G}_1\p{\v{q}, \v{x}, t} \v{q}_x + \M{G}_2\p{\v{q}, \v{x}, t} \v{q}_y
      = \v{s}\p{\v{q}, \v{x}, t}
    \end{equation}
    The local statements of the weak discontinuous Galerkin form are given by
    \begin{gather}
      \dintt{K_i}{}{\v{q}_t \phi_i^k(\v{x})
      - \v{f}_j\p{\v{q}, \v{x}, t} \phi^k_{i,x_j}(\v{x})
      + \M{G}_j\p{\v{q}, \v{x}, t} \v{q}_{x_j} \phi_i^k(\v{x})}{\v{x}} \\
      = -\dintt{\partial K_i}{}{\M{f}^* \v{n} \phi_i^k(\v{x})}{s}
      - \frac{1}{2}\dintt{\partial K_i}{}{
        \dintt{0}{1}{\M{G}(\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{x}, t)
      \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}}{\tau} \v{n}_L \phi_i^k}{s}
      + \dintt{K_i}{}{\v{s}\p{\v{q}, \v{x}, t} \phi_i^k(\v{x})}{\v{x}} \\
      \intertext{The vector \(\v{n}_L\) is the outward normal facing vector with respect
        to the left state, i.e.\ the state of \(\v{q}_L\).
        We can also consider all of the basis components at once, by using the
        test function \(\v{\phi}_i^T\) instead of \(\phi_i^k\).}
      \dintt{K_i}{}{\v{q}_t \v{\phi}_i^T(\v{x})
      - \M{f}\p{\v{q}, \v{x}, t} \M{D\phi}^T_{i} \p{\v{x}}
      + \M{G}_j\p{\v{q}, \v{x}, t} \v{q}_{x_j} \v{\phi}_i^T\p{\v{x}}}{\v{x}} \\
      = -\dintt{\partial K_i}{}{\M{f}^* \v{n} \v{\phi}^T_i(\v{x})}{s}
      - \frac{1}{2}\dintt{\partial K_i}{}{
        \dintt{0}{1}{\M{G}\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{x}, t}
      \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}}{\tau} \v{n}_L \v{\phi}_i^T\p{\v{x}}}{s}
      + \dintt{K_i}{}{\v{s}\p{\v{q}, \v{x}, t} \v{\phi}_i^T(\v{x})}{\v{x}}
      \intertext{Using the fact that \(\eval{\v{q}}{K_i} = \M{Q}_i \v{\phi}_i\), and
        dropping the explicit dependence on \(\v{x}\) for \(\v{\phi}_i\).}
      \dintt{K_i}{}{\M{Q}_{i,t} \v{\phi}_i \v{\phi}_i^T
      - \M{f}\p{\M{Q}_i \v{\phi}_i, \v{x}, t} \M{D\phi}^T_{i}
        + \M{G}_j\p{\M{Q}_i \v{\phi}_i, \v{x}, t}
        \M{Q}_i \v{\phi}_{i, x_j} \v{\phi}_i^T}{\v{x}} \\
      = -\dintt{\partial K_i}{}{\M{f}^* \v{n} \v{\phi}^T_i}{s}
      - \frac{1}{2}\dintt{\partial K_i}{}{
        \dintt{0}{1}{G\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{x}, t}
      \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}}{\tau} \v{n}_L \v{\phi}_i^T}{s}
      + \dintt{K_i}{}{\v{s}\p{\M{Q}_i \v{\phi}_i, \v{x}, t} \v{\phi}_i^T}{\v{x}}
      \intertext{Rearranging to solve for \(\M{Q}_{i, t}\).}
      \M{Q}_{i, t}\dintt{K_i}{}{\v{\phi}_i \v{\phi}_i^T}{\v{x}} =
      \dintt{K_i}{}{\M{f}\p{\M{Q}_i \v{\phi}_i, \v{x}, t} \M{D\phi}^T_{i}
      - \M{G}_j\p{\M{Q}_i \v{\phi}_i, \v{x}, t}
        \M{Q}_i \v{\phi}_{i, x_j} \v{\phi}_i^T}{\v{x}} \\
      -\dintt{\partial K_i}{}{\M{f}^* \v{n} \v{\phi}^T_i}{s}
      - \frac{1}{2}\dintt{\partial K_i}{}{
        \dintt{0}{1}{G\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{x}, t}
      \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}}{\tau} \v{n}_L \v{\phi}_i^T}{s}
      + \dintt{K_i}{}{\v{s}\p{\M{Q}_i \v{\phi}_i, \v{x}, t} \v{\phi}_i^T}{\v{x}}
      \intertext{Transforming integrals to canonical element, where \(\v{c}_{ij}'\) is
      the jth column of the jacobian of the function \(\v{c}_i(\v{x})\), which
      transforms the element \(K_i\) to the canonical element \(\mcK \).
      Also let \(f\) be the faces of \(\mcK \), with parameterizations \(\v{r}_f(s)\).}
      \M{Q}_{i, t} m_i \M{M} =
      \dintt{\mcK}{}{\M{f}\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t}
        \M{D\phi}^T \M{c}_i' m_i}{\v{\xi}}
      - \dintt{\mcK}{}{\sum{j=1}{d}{\M{G}_j\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t}
        \M{Q}_i \v{\phi}' \v{c}_{ij}'} \v{\phi}^T}{\v{\xi}} \\
      - \sum{f \in mcK}{}{
          \dintt{}{}{
            \M{f}^*\p{\v{b}_i\p{\v{r}_f(s)}} \v{n} \v{\phi}^T\p{\v{r}_f(s)}
            \norm{\v{b}_i'\p{\v{r}_f(s)} \v{r}_f'(s)}
          }{s}
        } \\
      - \frac{1}{2} \sum{f \in \mcK}{}{
          \dintt{}{}{
            \sum{j=1}{d}{
              \dintt{0}{1}{
                \M{G}_j\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i\p{\v{r}(s)}, t}
                \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
              }{\tau} \, n_{L,j}
            } \v{\phi}^T\p{\v{r}_f(s)} \norm{\v{b}_i'\p{\v{r}_f(s)} \v{r}_f'(s)}
          }{s}
        } \\
      + \dintt{\mcK}{}{
          \v{s}\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t} \v{\phi}^T m_i
        }{\v{\xi}}
      \intertext{Solving for \(\M{Q}_{i,t}\) gives}
      \M{Q}_{i, t} =
      \dintt{\mcK}{}{\M{f}\p{\M{Q}_i \v{\phi}, \v{b}_i\p{\v{\xi}}, t}
        \M{D\phi}^T \M{c}_i' }{\v{\xi}} \M{M}^{-1}
      - \dintt{\mcK}{}{
          \sum{j=1}{d}{
            \M{G}_j\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t}
            \M{Q}_i \v{\phi}' \v{c}_{ij}'
          } \v{\phi}^T
        }{\v{\xi}} \M{M}^{-1}\\
      - \frac{1}{m_i} \sum{f \in mcK}{}{
          \dintt{}{}{
            \M{f}^*\p{\v{b}_i\p{\v{r}_f(s)}} \v{n} \v{\phi}^T\p{\v{r}_f(s)}
            \norm{\v{b}_i'\p{\v{r}_f(s)} \v{r}_f'(s)}
          }{s}
        } \M{M}^{-1} \\
      - \frac{1}{2 m_i} \sum{f \in \mcK}{}{
          \dintt{}{}{
            \sum{j=1}{d}{
              \dintt{0}{1}{
                \M{G}_j\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i\p{\v{r}(s)}, t}
                \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
              }{\tau} \, n_{L,j}
            } \v{\phi}^T\p{\v{r}_f(s)} \norm{\v{b}_i'\p{\v{r}_f(s)} \v{r}_f'(s)}
          }{s}
        } \M{M}^{-1}\\
      + \dintt{\mcK}{}{
          \v{s}\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t} \v{\phi}^T
        }{\v{\xi}} \M{M}^{-1}
    \end{gather}

  \subsubsection{Rectangular Elements}
    Consider if the mesh contain rectangular elements, then
    \(K_i = \br{x_{i-1/2}, x_{i+1/2}} \times \br{y_{i-1/2}, y_{i+1/2}}\).
    The center of the element is \(\p{x_i, y_i}\) with
    \(\Delta x_i = x_{i+1/2} - x_{i-1/2}\) and \(\Delta y_i = y_{i+1/2} - y_{i-1/2}\).
    The canonical element is \(\mcK = \br{-1, 1} \times \br{-1, 1}\) with coordinates
    \(\v{\xi} = \br{\xi, \eta}\).
    The linear transformations are given by
    \begin{gather}
      \v{b}_i(\v{\xi}) = \br{\frac{\Delta x_i}{2} \xi + x_i,
        \frac{\Delta y_i}{2} \eta + y_i}^T \\
      \v{c}_i(\v{x}) = \br{\frac{2}{\Delta x_i} \p{x - x_i},
        \frac{2}{\Delta y_i} \p{y - y_i}}^T
    \end{gather}
    with Jacobians
    \begin{gather}
      \v{b}_i' =
      \begin{pmatrix}
        \frac{\Delta x_i}{2} & 0 \\
        0 & \frac{\Delta y_i}{2}
      \end{pmatrix} \\
      \v{c}_i' =
      \begin{pmatrix}
        \frac{2}{\Delta x_i} & 0 \\
        0 & \frac{2}{\Delta y_i}
      \end{pmatrix}
    \end{gather}

    The metric of element i is \(m_i = \frac{\Delta x_i \Delta y_i}{4}\).
    Also the parameterizations of the left, right, bottom, and top faces,
    \(r_l, r_r, r_b, r_t\) respectively, are given by
    \begin{gather}
      r_l(t) = \br{-1, t} \\
      r_r(t) = \br{1, t} \\
      r_b(t) = \br{t, -1} \\
      r_t(t) = \br{t, 1}
    \end{gather}
    for \(t \in \br{-1, 1}\).
    We can easily compute \(\norm{\v{b}_i'(\v{r}_f(t)) \v{r}_f'(t)}\) for each face as
    well
    \begin{gather}
      \norm{\v{b}_i'(\v{r}_l(t)) \v{r}_l'(t)} = \frac{\Delta y_i}{2} \\
      \norm{\v{b}_i'(\v{r}_r(t)) \v{r}_r'(t)} = \frac{\Delta y_i}{2} \\
      \norm{\v{b}_i'(\v{r}_b(t)) \v{r}_b'(t)} = \frac{\Delta x_i}{2} \\
      \norm{\v{b}_i'(\v{r}_t(t)) \v{r}_t'(t)} = \frac{\Delta x_i}{2}
    \end{gather}
    Substituting all of these into the formulation gives,
    \begin{gather}
      \M{Q}_{i, t} =
      \dintt{\mcK}{}{
        \frac{2}{\Delta x_i} \v{f}_1\p{\M{Q}_i \v{\phi}, \v{b}_i\p{\v{\xi}}, t}
        \v{\phi}^T_{\xi}
        + \frac{2}{\Delta y_i} \v{f}_2\p{\M{Q}_i \v{\phi}, \v{b}_i\p{\v{\xi}}, t}
        \v{\phi}^T_{\eta}
      }{\v{\xi}} \M{M}^{-1} \\
      - \dintt{\mcK}{}{
        \frac{2}{\Delta x_i}\M{G}_1\p{\M{Q}_i \v{\phi}_i, \v{b}_i\p{\v{\xi}}, t}
        \M{Q}_i \v{\phi}_{\xi} \v{\phi}^T
        + \M{G}_2\p{\M{Q}_i \v{\phi}_i, \v{b}_i\p{\v{\xi}}, t}
        \M{Q}_i \v{\phi}_{\eta} \v{\phi}^T
      }{\v{\xi}} \M{M}^{-1} \\
      + \frac{2}{\Delta x_i} \dintt{-1}{1}{
        \v{f}_1^*\p{\v{b}_i\p{\xi=-1, \eta}} \v{\phi}^T\p{\xi=-1, \eta}
      }{\eta} \M{M}^{-1} \\
      - \frac{2}{\Delta x_i} \dintt{-1}{1}{
        \v{f}_1^*\p{\v{b}_i\p{\xi=1, \eta}} \v{\phi}^T\p{\xi=1, \eta}
      }{\eta} \M{M}^{-1} \\
      + \frac{2}{\Delta y_i} \dintt{-1}{1}{
        \v{f}_2^*\p{\v{b}_i\p{\xi, \eta=-1}} \v{\phi}^T\p{\xi, \eta=-1}
      }{\xi} \M{M}^{-1} \\
      - \frac{2}{\Delta y_i} \dintt{-1}{1}{
        \v{f}_2^*\p{\v{b}_i\p{\xi, \eta=1}} \v{\phi}^T\p{\xi, \eta=1}
      }{\xi} \M{M}^{-1} \\
      - \frac{1}{\Delta x_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_1\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi=-1, \eta), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi=-1, \eta}
      }{\eta} \M{M}^{-1} \\
      - \frac{1}{\Delta x_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_1\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi=1, \eta), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi=1, \eta}
      }{\eta} \M{M}^{-1} \\
      - \frac{1}{\Delta y_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_2\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi, \eta=-1), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi, \eta=-1}
      }{\xi} \M{M}^{-1} \\
      - \frac{1}{\Delta y_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_2\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi, \eta=1), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi, \eta=1}
      }{\xi} \M{M}^{-1} \\
      + \dintt{\mcK}{}{
          \v{s}\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t} \v{\phi}^T
        }{\v{\xi}} \M{M}^{-1}
    \end{gather}
    For the case of a legendre orthogonal basis with orthogonality condition
    \[
      \frac{1}{4}\dintt{\mcK}{}{\phi^i(\v{\xi}) \phi^j(\v{\xi})}{\xi} = \delta_{ij},
    \]
    then the mass matrix and it's inverse become \(\M{M} = 4I\) and
    \(\M{M}^{-1} = \frac{1}{4}I\).
    \begin{gather}
      \M{Q}_{i, t} =
      \dintt{\mcK}{}{
        \frac{1}{2\Delta x_i} \v{f}_1\p{\M{Q}_i \v{\phi}, \v{b}_i\p{\v{\xi}}, t}
        \v{\phi}^T_{\xi}
        + \frac{1}{2\Delta y_i} \v{f}_2\p{\M{Q}_i \v{\phi}, \v{b}_i\p{\v{\xi}}, t}
        \v{\phi}^T_{\eta}
      }{\v{\xi}} \\
      - \dintt{\mcK}{}{
        \frac{1}{2\Delta x_i}\M{G}_1\p{\M{Q}_i \v{\phi}_i, \v{b}_i\p{\v{\xi}}, t}
        \M{Q}_i \v{\phi}_{\xi} \v{\phi}^T
        + \frac{1}{2 \Delta y_i} \M{G}_2\p{\M{Q}_i \v{\phi}_i, \v{b}_i\p{\v{\xi}}, t}
        \M{Q}_i \v{\phi}_{\eta} \v{\phi}^T
      }{\v{\xi}} \\
      + \frac{1}{2\Delta x_i} \dintt{-1}{1}{
        \v{f}_1^*\p{\v{b}_i\p{\xi=-1, \eta}} \v{\phi}^T\p{\xi=-1, \eta}
      }{\eta} \\
      - \frac{1}{2\Delta x_i} \dintt{-1}{1}{
        \v{f}_1^*\p{\v{b}_i\p{\xi=1, \eta}} \v{\phi}^T\p{\xi=1, \eta}
      }{\eta} \\
      + \frac{1}{2\Delta y_i} \dintt{-1}{1}{
        \v{f}_2^*\p{\v{b}_i\p{\xi, \eta=-1}} \v{\phi}^T\p{\xi, \eta=-1}
      }{\xi} \\
      - \frac{1}{2\Delta y_i} \dintt{-1}{1}{
        \v{f}_2^*\p{\v{b}_i\p{\xi, \eta=1}} \v{\phi}^T\p{\xi, \eta=1}
      }{\xi} \\
      - \frac{1}{4\Delta x_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_1\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi=-1, \eta), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi=-1, \eta}
      }{\eta} \\
      - \frac{1}{4\Delta x_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_1\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi=1, \eta), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi=1, \eta}
      }{\eta} \\
      - \frac{1}{4\Delta y_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_2\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi, \eta=-1), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi, \eta=-1}
      }{\xi} \\
      - \frac{1}{4\Delta y_i} \dintt{-1}{1}{
        \dintt{0}{1}{
          \M{G}_2\p{\v{\psi}\p{\tau, \v{q}_L, \v{q}_R}, \v{b}_i(\xi, \eta=1), t}
          \v{\psi}_{\tau}\p{\tau, \v{q}_L, \v{q}_R}
        }{\tau} \v{\phi}^T\p{\xi, \eta=1}
      }{\xi} \\
      + \frac{1}{4}\dintt{\mcK}{}{
          \v{s}\p{\M{Q}_i \v{\phi}, \v{b}_i(\v{\xi}), t} \v{\phi}^T
        }{\v{\xi}}
    \end{gather}

  \subsubsection{Triangular Elements}
